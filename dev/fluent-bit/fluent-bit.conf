[SERVICE]
    flush                     1
    log_level                 info
    parsers_file              /fluent-bit/etc/parsers.conf
    storage.path              /fluent-bit/storage
    storage.sync              normal
    storage.backlog.mem_limit 256MB

[INPUT]
    Name                tail
    Path                /var/lib/docker/containers/*/*.log
    Tag                 docker.*
    # 도커 로그 파일 파서
    Parser              docker
    DB                  /fluent-bit/state/tail.db
    Mem_Buf_Limit       256MB
    Skip_Long_Lines     On
    Refresh_Interval    5
    Rotate_Wait         10
    # 유실 방지 (디스크 백로그)
    storage.type        filesystem

# 컨테이너 로그의 "log" 필드(JSON 문자열)를 레코드로 승격
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json
    Reserve_Data  On

# 승격 후 원본 log 키 제거
[FILTER]
    Name      modify
    Match     docker.*
    Remove    log

# 선택: 공통 필드 주입
[FILTER]
    Name    record_modifier
    Match   docker.*
    Record  cluster local
    Record  pipeline app-stdout

[OUTPUT]
    Name        kafka
    Match       docker.*
    Brokers     kafka:9092

    # 기본/백업 토픽
    topics              logs.app
    # ✅ 레코드의 "topic" 필드를 토픽명으로 사용
    topic_key           topic
    # (선택) 레코드의 "key" 필드를 Kafka message key로 사용
    message_key_field   key
    # (선택) 레코드의 "ts" 필드를 타임스탬프로 사용
    timestamp_key       ts
    timestamp_format    iso8601

    rdkafka.queue.buffering.max.kbytes 102400
    rdkafka.compression.type           gzip
    rdkafka.request.required.acks      1
    rdkafka.log.connection.close       false
