# ClickHouse 분석 웨어하우스를 Grafana와 자동 연동하기 위한 데이터 소스 정의
apiVersion: 1

# 기존 Grafana DB에 저장된 datasource가 남아있으면(특히 secureJsonData)
# 파일 변경이 적용되지 않고 예전 자격증명(log_user)으로 계속 조회할 수 있다.
# 아래 deleteDatasources 로 항상 프로비저닝 파일을 source-of-truth로 만든다.
deleteDatasources:
  - name: ClickHouse
    orgId: 1

datasources:
  - name: ClickHouse
    uid: clickhouse
    type: grafana-clickhouse-datasource
    access: proxy
    url: http://clickhouse:8123
    isDefault: true
    editable: false
    jsonData:
      defaultDatabase: analytics
      defaultTable: fact_log_agg_1m
      port: 8123
      protocol: http
      host: clickhouse
      username: grafana_user
      tlsSkipVerify: false
      # Grafana 패널 쿼리가 큰 시간 범위를 조회할 때 기본 64초 제한에 걸려
      # TIMEOUT_EXCEEDED가 발생할 수 있어 datasource 단에서 타임아웃을 상향한다.
      # NOTE: 플러그인이 string으로 파싱하는 경로가 있어 숫자는 문자열로 전달한다.
      dialTimeout: "10"
      # 집계 테이블로 전환했으므로, 조회는 수 초 내로 끝나야 정상이다.
      # 큰 값은 오히려 원본 fact_log 스캔 같은 비정상 쿼리를 오래 살려 ingest를 막을 수 있어 보수적으로 설정.
      queryTimeout: "60"
    secureJsonData:
      password: grafana_pwd
