[
  {
    "datasource": {
      "type": "grafana-clickhouse-datasource",
      "uid": "clickhouse"
    },
    "description": "ClickHouse 시스템 쿼리(QPS)를 모니터링합니다.",
    "fieldConfig": {
      "defaults": {
        "color": {
          "mode": "palette-classic"
        },
        "custom": {
          "axisLabel": "QPS",
          "axisPlacement": "auto",
          "axisSoftMin": 0,
          "drawStyle": "line",
          "fillOpacity": 12,
          "lineWidth": 2,
          "showPoints": "auto",
          "spanNulls": true
        },
        "mappings": [],
        "thresholds": {
          "mode": "absolute",
          "steps": [
            {
              "color": "green",
              "value": null
            }
          ]
        },
        "unit": "ops"
      },
      "overrides": []
    },
    "gridPos": { "h": 9, "w": 12, "x": 0, "y": 36 },
    "id": 1,
    "options": {
      "legend": {
        "calcs": [],
        "displayMode": "list",
        "placement": "bottom",
        "showLegend": true
      },
      "tooltip": {
        "mode": "single",
        "sort": "none"
      }
    },
    "pluginVersion": "10.4.2",
    "targets": [
      {
        "datasource": {
          "type": "grafana-clickhouse-datasource",
          "uid": "clickhouse"
        },
        "queryType": "sql",
        "rawQuery": true,
        "rawSql": "SELECT\n  toStartOfInterval(event_time, toIntervalSecond($__interval_s)) AS bucket,\n  count() / nullIf($__interval_s, 0) AS qps\nFROM system.query_log\nWHERE $__timeFilter(event_time)\n  AND type = 'QueryFinish'\nGROUP BY bucket\nORDER BY bucket",
        "refId": "A"
      }
    ],
    "title": "쿼리 QPS",
    "type": "timeseries"
  },
  {
    "datasource": {
      "type": "grafana-clickhouse-datasource",
      "uid": "clickhouse"
    },
    "description": "쿼리 지연(p95)을 모니터링합니다.",
    "fieldConfig": {
      "defaults": {
        "color": {
          "mode": "continuous-GrYlRd"
        },
        "custom": {
          "axisLabel": "p95 쿼리 지연",
          "axisPlacement": "auto",
          "axisSoftMin": 0,
          "drawStyle": "line",
          "lineWidth": 2,
          "showPoints": "never",
          "spanNulls": true
        },
        "mappings": [],
        "unit": "ms"
      },
      "overrides": []
    },
    "gridPos": { "h": 9, "w": 12, "x": 12, "y": 18 },
    "id": 5,
    "options": {
      "legend": {
        "displayMode": "list",
        "placement": "bottom",
        "showLegend": true
      },
      "tooltip": {
        "mode": "single",
        "sort": "none"
      }
    },
    "pluginVersion": "10.4.2",
    "targets": [
      {
        "datasource": {
          "type": "grafana-clickhouse-datasource",
          "uid": "clickhouse"
        },
        "queryType": "sql",
        "rawQuery": true,
        "rawSql": "SELECT\n  toStartOfInterval(event_time, toIntervalSecond($__interval_s)) AS bucket,\n  quantile(0.95)(query_duration_ms) AS p95_ms\nFROM system.query_log\nWHERE $__timeFilter(event_time)\n  AND type = 'QueryFinish'\nGROUP BY bucket\nORDER BY bucket",
        "refId": "A"
      }
    ],
    "title": "쿼리 지연 p95",
    "type": "timeseries"
  },
  {
    "datasource": {
      "type": "grafana-clickhouse-datasource",
      "uid": "clickhouse"
    },
    "description": "ClickHouse 쿼리 실패(예외) QPS를 모니터링합니다.",
    "fieldConfig": {
      "defaults": {
        "color": {
          "mode": "palette-classic"
        },
        "custom": {
          "axisLabel": "Error QPS",
          "axisPlacement": "auto",
          "axisSoftMin": 0,
          "drawStyle": "line",
          "lineWidth": 2,
          "showPoints": "never",
          "spanNulls": true
        },
        "mappings": [],
        "unit": "ops"
      },
      "overrides": []
    },
    "gridPos": { "h": 9, "w": 12, "x": 0, "y": 45 },
    "id": 3,
    "options": {
      "legend": {
        "displayMode": "list",
        "placement": "bottom",
        "showLegend": true
      },
      "tooltip": {
        "mode": "single",
        "sort": "none"
      }
    },
    "pluginVersion": "10.4.2",
    "targets": [
      {
        "datasource": {
          "type": "grafana-clickhouse-datasource",
          "uid": "clickhouse"
        },
        "queryType": "sql",
        "rawQuery": true,
        "rawSql": "SELECT\n  toStartOfInterval(event_time, toIntervalSecond($__interval_s)) AS bucket,\n  countIf(exception_code != 0) / nullIf($__interval_s, 0) AS error_qps\nFROM system.query_log\nWHERE $__timeFilter(event_time)\n  AND type = 'QueryFinish'\nGROUP BY bucket\nORDER BY bucket",
        "refId": "A"
      }
    ],
    "title": "쿼리 Error QPS",
    "type": "timeseries"
  },
  {
    "datasource": { "type": "grafana-clickhouse-datasource", "uid": "clickhouse" },
    "description": "쿼리 종류(SELECT/INSERT/DDL/기타)별 QPS를 확인합니다.",
    "fieldConfig": {
      "defaults": {
        "color": { "mode": "palette-classic" },
        "custom": {
          "axisLabel": "종류별 QPS",
          "axisPlacement": "auto",
          "axisSoftMin": 0,
          "drawStyle": "line",
          "lineWidth": 2,
          "showPoints": "never",
          "spanNulls": true
        },
        "mappings": [],
        "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] },
        "unit": "ops"
      },
      "overrides": []
    },
    "gridPos": { "h": 9, "w": 12, "x": 12, "y": 27 },
    "id": 2,
    "options": {
      "legend": { "displayMode": "table", "placement": "bottom", "showLegend": true },
      "tooltip": { "mode": "multi", "sort": "none" }
    },
    "pluginVersion": "10.4.2",
    "targets": [
      {
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "clickhouse" },
        "queryType": "sql",
        "rawQuery": true,
        "rawSql": "SELECT\n  toStartOfInterval(event_time, toIntervalSecond($__interval_s)) AS bucket,\n  multiIf(\n    startsWith(lowerUTF8(trimLeft(query)), 'select'), 'select',\n    startsWith(lowerUTF8(trimLeft(query)), 'insert'), 'insert',\n    startsWith(lowerUTF8(trimLeft(query)), 'create'), 'ddl',\n    startsWith(lowerUTF8(trimLeft(query)), 'alter'), 'ddl',\n    startsWith(lowerUTF8(trimLeft(query)), 'drop'), 'ddl',\n    'other'\n  ) AS kind,\n  count() / nullIf($__interval_s, 0) AS qps\nFROM system.query_log\nWHERE $__timeFilter(event_time)\n  AND type = 'QueryFinish'\nGROUP BY bucket, kind\nORDER BY bucket, kind",
        "refId": "A"
      }
    ],
    "title": "쿼리 종류별 QPS",
    "type": "timeseries"
  }
]
