[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     debug
    Parsers_File  /fluent-bit/etc/parsers.conf 

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*-json.log
    Parser            docker            
    Tag               docker.all
    Read_From_Head    true

# 1) "log" 문자열을 JSON으로 펼쳐 최상위에 topic/key/ts/value 올리기
[FILTER]
    Name          parser
    Match         docker.all
    Key_Name      log
    Parser        json
    Reserve_Data  true
    Preserve_Key  false

# 2) topic이 있으면 retag: parsed.<topic>   ★ 포인트: parsed.$1
[FILTER]
    Name          rewrite_tag
    Match         docker.all
    Rule          $topic ^(.+)$ parsed.$1 true

# 3) 눈으로 확인: topic 추출 성공한 것만 출력
[OUTPUT]
    Name    stdout
    Match   parsed.*
    Format  json_lines

# 4) Kafka: topic 추출 성공한 것만 전송 + 동적 토픽 라우팅
[OUTPUT]
    Name                  kafka
    Match                 parsed.*
    Brokers               kafka:9092
    topics                logs.app
    topic_key             topic
    dynamic_topic         true
    message_key_field     key
    timestamp_key         ts
    timestamp_format      iso8601

    rdkafka.request.required.acks      1
    rdkafka.compression.type           gzip
    rdkafka.queue.buffering.max.kbytes 102400
